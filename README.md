**Cascana.OKO** – это распределенная система интеллектуального видеонаблюдения реального времени. Система построена на принципах микросервисной архитектуры, модульности, управления через события.

## Технологии

Для создания системы использовалось только программное обеспечение **Open Source**.
- Работа с видеопотоком: ffmpeg
- Детектирование объектов (лиц) на изображении: OpenCV
- Web-сервисы: NodeJS, Express, Socket.IO
- База данных: MariaDB
- Пользовательский web-интерфейс: Bootstrap, jQuery
- Управление процессами: PM2
- Управление зависимостями и сборка: npm, make

Система предназначена для развертывания на платформе Linux (семейство RedHat).
Реализована интеграция с рядом внешних систем.

## Архитектура

На каждую камеру (источник видеосигнала) запускается отдельный модульный процесс NodeJS. Все процессы/сервисы системы управляются менеджером процессов PM2. Система может работать с любыми источниками и форматами видеосигнала, поддерживаемыми библиотекой ffmpeg.

Принципиальная схема взаимодействия сервисов системы приведена на рисунке ниже. Желтым цветом выделены компоненты, вошедшие в дистрибутив.

![Архитектура](/demo/CascanaOKO_overview_github.png)


## Хранение данных
В системе используются две базы данных: статистики и персональных данных.

Персональные данные также могут быть извлечены из БД СКУД.

База персональных данных содержит, как минимум, ФИО и уникальный идентификатор личности, по
которому и выполняется сопоставление при распознавании. Сервис распознавания хранит только
фотографии и идентификаторы личности.

Фотографии в системе хранятся в отдельных файлах. Изображения лиц, полученных из видеопотока,
записываются на диск в структуре каталогов, именованных по камерам и по датам. Каждый файл имеет
уникальное имя-идентификатор. Перенос изображений в архив выполняется программой-планировщиком cron (на схеме не показан).

## Пользовательский интерфейс

Система имеет простой пользовательский интерфейс:
- Страница "Видео с камер": контроль происходящего на камерах с журналом событий.
- Страница "Конфигурация": управление процессами и конфигурацией.

Некоторые скриншоты приведены ниже.

![Скриншот](/demo/Screenshot1.png)

![Скриншот](/demo/Screenshot5.png)

![Скриншот](/demo/Screenshot9.png)

![Скриншот](/demo/Screenshot13.png)

Другие скриншоты и скринкасты вы можете найти в папке demo.

## Структура проекта

### config
Сервис конфигурирования и управления процессами системы видеонаблюдения. Устанавливается на каждый хост, где это требуется.

### config_files
Скрипты первоначальной конфигурации системы. Используются утилитой ./generate_configs.sh.

### config_ui
Сервис, предоставляющий административный web-интерфейс системы видеонаблюдения. Устанавливается, как правило, один на систему. Работает в связке с config.

### demo
Демонстрационные материалы: скриншоты, скринкасты, описание.

### detector
Главный сервис системы. Запускается из расчета один сервис на камеру (источник видеосигнала). Основная задача - детектиррвание объектов (лиц) в видеопотоке. Используется библиотека OpenCV. Захват и разбор видеопотока осуществляется дочерним процессом ffmpeg. Сервис имеет модульную организацию. Модули следующие:
- **archive** - модуль сохранения вырезанных из видеопотока изображений в файловой системе.
- **ejabberd** - модуль интеграции с сервером мгновенных сообщений eJabberd. Используется для оповещения о событиях системы. Модуль работает через чат-бота (поставляется по запросу).
- **face_detect** - модуль детектирования человеческих лиц на изображении с последующим вырезанием фото.
- **kryptonite** - модуль интеграции с сервисом распознавания компании Криптонит. Используется для верификации лица.
- **log** - модуль обработки результатов распознавания, не предусматривающий никаких действий, кроме генерации событий.
- **mailru** - модуль интеграции с облачным сервисом распознавания Mail.ru Vision. Используется для идентификации лица. Работает в связке с БД персональных данных.
- **monitor** - модуль мониторинга сервиса детектирования, предназначенный для интеграции с пользовательским web-интерфейсом. Модуль рассылает события по протоколу Websocket.
- **raw** - модуль-заглушка, исключающий отправку фотографий на распознавание.
- **receiver** - модуль-приемник для интеграции со сторонними web-сервисами. Модуль принимает HTTP/HTTPS POST запрос от сервиса и генерирует соответствующее событие.
- **sendmail** - модуль интеграции с почтовым агентом sendmail. Предназначен для рассылки уведомлений.
- **stat** - модуль сбора статистики.

### ffserver
Папка с шаблоном конфигурационного файла видеосервера. Сюда будут установлены исходники библиотеки ffmpeg/ffserver (см INSTALL.md). Видеосервер предназначен для преобразования и раздачи видеопотоков пользовательским браузерам.

### gallery
Вспомогательный сервис, предоставляющий пользовательский web-интерфейс, демонстрирующий вырезанные из видеопотока лица. Изображения загружаются с диска.

### lib
Библиотека backend.

### lib_ui
Библиотека frontend.

### mailru_ui
Простой web-интерфейс, позволяющий выгружать изображения в облачную систему распознавания Mail.ru Vision, а также тестировать некоторые ее функции. Выгружаемые изображения сохраняются в файловой системе на сервере.

### mariadb
Сервис интеграции с БД MariaDB. Данная БД используется в системе для хранения статистики и персональных данных. Предоставляет API для взаимодействия с БД по протоколу HTTP/HTTPS.

### photo
Сервис отгрузки фотографий, хранящихся в файловой системе.

### sql
Скрипты создания баз данных и таблиц.

### tls
Здесь хранятся SSL-сертификаты.

### ui
Сервис, предоставляющий пользовательский web-интерфейс к системе видеонаблюдения.

### video_sources
Видео файлы для первоначальной настройки и тестирования системы.

## Лицензия

MIT<br />
Copyright (c) 2020 Шторм Технологии<br />
Компоненты системы могут иметь другие лицензии
